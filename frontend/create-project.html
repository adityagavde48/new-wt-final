<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create Project</title>

    <!-- Bootstrap CSS -->
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
    />

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-main: #050816;
            --card-bg: #0b1020;
            --accent: #6366f1;
            --accent-soft: rgba(99, 102, 241, 0.2);
            --text-main: #ffffff;
            --text-muted: #a3a3b8;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont,
                "Segoe UI", sans-serif;
            background: radial-gradient(circle at top, #1e293b 0, #020617 35%, #000 100%);
            color: var(--text-main);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .page-wrapper {
            width: 100%;
            max-width: 900px;
        }

        .card-create-project {
            background: radial-gradient(circle at top left, #1f2937 0, #020617 60%);
            border-radius: 24px;
            border: 1px solid rgba(148, 163, 184, 0.3);
            box-shadow:
                0 0 30px rgba(15, 23, 42, 0.9),
                0 0 80px rgba(99, 102, 241, 0.35);
            padding: 28px 24px 24px;
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.7s ease-out both;
        }

        .glow-orb {
            position: absolute;
            width: 260px;
            height: 260px;
            background: radial-gradient(circle, rgba(96, 165, 250, 0.3), transparent 70%);
            top: -80px;
            right: -80px;
            filter: blur(1px);
            opacity: 0.9;
            pointer-events: none;
        }

        .card-header-custom {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 18px;
        }

        .card-header-left h2 {
            font-size: 1.4rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pill {
            font-size: 0.7rem;
            text-transform: uppercase;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.6);
            color: var(--text-muted);
            letter-spacing: 0.08em;
        }

        .divider-soft {
            height: 1px;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(148, 163, 184, 0.6),
                transparent
            );
            margin-bottom: 20px;
        }

        label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .form-control,
        .form-select {
            background-color: rgba(15, 23, 42, 0.9);
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.6);
            color: var(--text-main);
            padding: 10px 12px;
            font-size: 0.9rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent-soft);
            background-color: rgba(15, 23, 42, 0.95);
            color: #fff;
            transform: translateY(-1px);
        }

        .form-control::placeholder {
            color: rgba(148, 163, 184, 0.8);
        }

        .input-help {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .required-badge {
            color: #f97373;
            margin-left: 4px;
        }

        .btn-submit {
            border-radius: 999px;
            padding: 10px 22px;
            font-size: 0.95rem;
            font-weight: 500;
            border: none;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            color: #fff;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow:
                0 10px 30px rgba(79, 70, 229, 0.4),
                0 0 15px rgba(129, 140, 248, 0.4);
            transition: transform 0.15s ease, box-shadow 0.15s ease, filter 0.15s ease;
        }

        .btn-submit:hover {
            transform: translateY(-1px) scale(1.01);
            box-shadow:
                0 16px 40px rgba(79, 70, 229, 0.55),
                0 0 20px rgba(129, 140, 248, 0.7);
            filter: brightness(1.03);
        }

        .btn-submit:active {
            transform: translateY(0px) scale(0.99);
            box-shadow:
                0 6px 18px rgba(79, 70, 229, 0.35),
                0 0 12px rgba(129, 140, 248, 0.5);
        }
        .footer-text {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: right;
            margin-top: 8px;
        }

        .alert-custom {
            border-radius: 12px;
            padding: 10px 12px;
            font-size: 0.85rem;
        }

        .alert-error {
            background-color: rgba(248, 113, 113, 0.09);
            border: 1px solid rgba(248, 113, 113, 0.4);
            color: #fecaca;
        }

        .alert-success-custom {
            background-color: rgba(22, 163, 74, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.6);
            color: #bbf7d0;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(18px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 576px) {
            .card-create-project {
                padding: 22px 18px 18px;
            }

            .card-header-custom {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <div class="card-create-project">
            <div class="glow-orb"></div>

            <div class="card-header-custom">
                <div class="card-header-left">
                    <h2>
                        Create New Project
                        <span class="badge rounded-pill bg-dark border border-secondary ms-1">
                            Owner
                        </span>
                    </h2>
                    <div class="text-muted small">
                        Fill in the details to set up a new project.
                    </div>
                </div>
                <span class="pill">Project Setup</span>
            </div>

            <div id="alert-container"></div>

            <div class="divider-soft"></div>

            <form id="createProjectForm" novalidate>
                <!-- Project Title -->
                <div class="mb-3">
                    <label for="projectTitle" class="form-label">
                        Project Title
                        <span class="required-badge">*</span>
                    </label>
                    <input
                        type="text"
                        class="form-control"
                        id="projectTitle"
                        placeholder="e.g. Smart Parking Management System"
                        required
                    />
                    <div class="input-help">
                        A short, clear name for your project.
                    </div>
                </div>

                <!-- Description -->
                <!-- Requirements -->
<div class="mb-3">
  <label for="projectRequirements" class="form-label">
    Project Requirements
    <span class="required-badge">*</span>
  </label>
  <textarea
    class="form-control"
    id="projectRequirements"
    rows="4"
    placeholder="List functional & non-functional requirements..."
    required
  ></textarea>
  <div class="input-help">
    Write key requirements in text form (summary).
  </div>
</div>


                <!-- Requirement PDF -->
                <div class="mb-3">
                    <label for="requirementPdf" class="form-label">
                        Requirement Document (PDF)
                        <span class="required-badge">*</span>
                    </label>
                    <input
                        type="file"
                        class="form-control"
                        id="requirementPdf"
                        accept="application/pdf"
                        required
                    />
                    <div class="input-help">
                        Upload the SRS or requirement PDF file for this project.
                    </div>
                </div>

                <!-- Manager Email with suggestions -->
                <div class="mb-3">
                    <label for="managerEmail" class="form-label">
                        Manager Email
                        <span class="required-badge">*</span>
                    </label>
                    <input
                        type="email"
                        class="form-control"
                        id="managerEmail"
                        placeholder="Start typing manager email..."
                        list="managerEmailSuggestions"
                        autocomplete="off"
                        required
                    />
                    <datalist id="managerEmailSuggestions"></datalist>
                    <div class="input-help">
                        Suggestions will appear as you type (from backend).
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="small text-muted">
                        <span class="required-badge">*</span> Required fields
                    </div>
                    <button type="submit" class="btn-submit">
                        <span>Create Project</span>
                        <span>âž¤</span>
                    </button>
                </div>
            </form>

            <div class="footer-text">
                Connected to backend with REST API (you can change the endpoints).
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    ></script>

    <script>
const form = document.getElementById("createProjectForm");
const alertContainer = document.getElementById("alert-container");
const managerEmailInput = document.getElementById("managerEmail");
const managerEmailSuggestions = document.getElementById("managerEmailSuggestions");

// âœ… BACKEND URL
const API_BASE_URL = "http://localhost:5000";
const MANAGER_SUGGEST_API = API_BASE_URL + "/api/managers";
const CREATE_PROJECT_API = API_BASE_URL + "/api/projects";

const token = localStorage.getItem("token");
if (!token) {
  window.location.href = "login.html";
}

// ðŸ”” alert helper
function showAlert(message, type = "error") {
  alertContainer.innerHTML = "";
  const div = document.createElement("div");
  div.className =
    "alert-custom mb-3 " +
    (type === "error" ? "alert-error" : "alert-success-custom");
  div.textContent = message;
  alertContainer.appendChild(div);
  setTimeout(() => div.remove(), 3000);
}

// ================= EMAIL SUGGESTION =================

let debounceTimer = null;
managerEmailInput.addEventListener("input", () => {
  const query = managerEmailInput.value.trim().toLowerCase();

  if (!query) {
    managerEmailSuggestions.innerHTML = "";
    return;
  }

  clearTimeout(debounceTimer);

  debounceTimer = setTimeout(async () => {
    try {
      const res = await fetch(
        `${MANAGER_SUGGEST_API}?query=${encodeURIComponent(query)}`,
        {
          method: "GET",
          headers: {
            Authorization: `Bearer ${token}`,
          },
        }
      );

      if (!res.ok) {
        managerEmailSuggestions.innerHTML = "";
        return;
      }

      const data = await res.json();
      managerEmailSuggestions.innerHTML = "";

      if (!Array.isArray(data) || data.length === 0) return;

      const emails = new Set();

      data.forEach((user) => {
        if (user?.email && !emails.has(user.email)) {
          emails.add(user.email);

          const option = document.createElement("option");
          option.value = user.email;
          managerEmailSuggestions.appendChild(option);
        }
      });
    } catch (err) {
      console.error("Email suggestion error:", err);
      managerEmailSuggestions.innerHTML = "";
    }
  }, 300);
});


// ================= CREATE PROJECT =================

form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const title = document.getElementById("projectTitle").value.trim();
  const requirements = document
  .getElementById("projectRequirements")
  .value.trim();
const managerEmail = managerEmailInput.value.trim();
const pdfFile = document.getElementById("requirementPdf").files[0];

if (!title || !requirements || !managerEmail || !pdfFile) {
  showAlert("All fields are required");
  return;
}

const formData = new FormData();
formData.append("title", title);
formData.append("description", requirements); // keep backend compatible
formData.append("managerEmail", managerEmail);
formData.append("requirementPdf", pdfFile);


  try {
    const res = await fetch(CREATE_PROJECT_API, {
      method: "POST",
      headers: {
        Authorization: `Bearer ${token}`,
      },
      body: formData,
    });

    const data = await res.json();

    if (!res.ok) {
      showAlert(data.message || "Project creation failed");
      return;
    }

    showAlert("Project created & request sent!", "success");
    form.reset();
    managerEmailSuggestions.innerHTML = "";

    setTimeout(() => {
      window.location.href = "dashboard.html";
    }, 1500);
  } catch (err) {
    console.error(err);
    showAlert("Server error");
  }
});

    </script>
</body>
</html>
