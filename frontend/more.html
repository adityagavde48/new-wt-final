<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NexTask – Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

  <style>
    body {
      background: radial-gradient(circle at top, #111827, #020617);
      color: #e5e7eb;
      min-height: 100vh;
    }

    .dark-card {
      background: linear-gradient(145deg, #0b1220, #020617);
      border: 1px solid #1f2937;
      border-radius: 16px;
      padding: 1.5rem;
    }

    .nav-btn {
      cursor: pointer;
      border: 1px solid #1f2937;
      transition: 0.3s;
    }

    .nav-btn.active {
      border-color: #6366f1;
    }

    .slider-track {
      display: flex;
      transition: transform 0.6s ease;
    }

    .slide-panel {
      min-width: 100%;
    }
  </style>
</head>

<body>
<div class="container py-4">
  <h2 class="mb-4">Dashboard Overview</h2>

  <!-- NAV -->
  <div class="row g-3">
    <div class="col-md-4">
      <div class="dark-card nav-btn active" onclick="showPanel(0)">Projects</div>
    </div>
    <div class="col-md-4">
      <div class="dark-card nav-btn" onclick="showPanel(1)">Tasks</div>
    </div>
    <div class="col-md-4">
      <div class="dark-card nav-btn" onclick="showPanel(2)">Deadlines</div>
    </div>
  </div>

  <!-- SLIDER -->
  <div class="overflow-hidden mt-4">
    <div class="slider-track" id="sliderTrack">
      <div class="slide-panel">
        <div class="dark-card">
          <h4>Active Projects</h4>
          <div id="projectsContainer">Loading...</div>
        </div>
      </div>

      <div class="slide-panel">
        <div class="dark-card">
          <h4>My Tasks</h4>
          <div id="tasksContainer">Loading...</div>
        </div>
      </div>

      <div class="slide-panel">
        <div class="dark-card">
          <h4>Upcoming Deadlines</h4>
          <div id="deadlinesContainer">Loading...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const API = "http://localhost:5000/api";

const sliderTrack = document.getElementById("sliderTrack");
const navBtns = document.querySelectorAll(".nav-btn");

function getToken() {
  return localStorage.getItem("token");
}

function showPanel(index) {
  sliderTrack.style.transform = `translateX(-${index * 100}%)`;
  navBtns.forEach(b => b.classList.remove("active"));
  navBtns[index].classList.add("active");

  if (index === 0) loadProjects();
  if (index === 1) loadTasks();
  if (index === 2) loadDeadlines();
}

/* ================= PROJECTS ================= */
async function loadProjects() {
  const el = document.getElementById("projectsContainer");
  el.textContent = "Loading...";

  const token = getToken();
  if (!token) return location.href = "login.html";

  try {
    const res = await fetch(`${API}/projects/active-projects`, {
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      }
    });

    const text = await res.text();
    if (!res.ok) throw new Error(text);

    const data = JSON.parse(text);
    console.log("✅ Active Projects:", data);

    el.innerHTML = "";

    if (!data.length) {
      el.textContent = "No active projects";
      return;
    }

    data.forEach(p => {
      const div = document.createElement("div");
      div.className = "p-2 mb-2 border rounded";
      div.style.cursor = "pointer";
      div.textContent = p.title;

      div.onclick = () => {
        localStorage.setItem("selectedProjectId", p.id);
        window.location.href =
          (p.role === "OWNER" || p.role === "MANAGER")
            ? `project-dashboard.html?projectId=${p.id}`
            : `member-dashboard.html?projectId=${p.id}`;
      };

      el.appendChild(div);
    });

  } catch (err) {
    console.error("❌ loadProjects:", err.message);
    el.textContent = "Failed to load projects";
  }
}

/* ================= TASKS ================= */
async function loadTasks() {
  const el = document.getElementById("tasksContainer");
  el.textContent = "Loading...";

  const token = getToken();
  if (!token) return location.href = "login.html";

  try {
    const res = await fetch(`${API}/tasks/my`, {
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      }
    });

    const text = await res.text();
    if (!res.ok) throw new Error(text);

    const tasks = JSON.parse(text);
    console.log("✅ My Tasks:", tasks);

    el.innerHTML = "";

    if (!tasks.length) {
      el.textContent = "No tasks assigned";
      return;
    }

    tasks.forEach(t => {
      el.innerHTML += `
        <div class="mb-2">
          <strong>${t.title}</strong><br/>
          <small>Status: ${t.status}</small>
        </div>
      `;
    });

  } catch (err) {
    console.error("❌ loadTasks:", err.message);
    el.textContent = "Failed to load tasks";
  }
}

/* ================= DEADLINES ================= */
async function loadDeadlines() {
  const el = document.getElementById("deadlinesContainer");
  el.textContent = "Loading...";

  const token = getToken();
  if (!token) return location.href = "login.html";

  try {
    const res = await fetch(`${API}/deadlines/upcoming`, {
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      }
    });

    const text = await res.text();
    if (!res.ok) throw new Error(text);

    const data = JSON.parse(text);
    console.log("✅ Deadlines:", data);

    el.innerHTML = "";

    if (!data.length) {
      el.textContent = "No upcoming deadlines";
      return;
    }

    data.forEach(d => {
      el.innerHTML += `
        <div class="mb-2">
          <strong>${d.title}</strong><br/>
          <small>${new Date(d.dueDate).toDateString()}</small>
        </div>
      `;
    });

  } catch (err) {
    console.error("❌ loadDeadlines:", err.message);
    el.textContent = "Failed to load deadlines";
  }
}

/* ================= INIT ================= */
document.addEventListener("DOMContentLoaded", () => {
  if (!getToken()) return location.href = "login.html";
  showPanel(0);
});
</script>
</body>
</html>
